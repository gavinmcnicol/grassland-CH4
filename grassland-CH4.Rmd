# Grassland Methane Emissions in FLUXNET-CH4

```{r, echo=FALSE, return=FALSE}
library(tidyverse)
library(lubridate)
library(amerifluxr)
library(patchwork)

read_site <- function(fp) {
  df <- read_csv(fp, na='-9999') %>% 
    mutate(date = parse_datetime(as.character(TIMESTAMP_START), '%Y%m%d%H%M'))
}

calc_annual <- function(df) {
  annual <- df %>% 
  group_by(year = floor_date(as_date(date), 'year')) %>% 
  summarize(FCH4_an = sum(FCH4_F, na.rm = TRUE) * 1800 * 10^-9,
            NEE_an = sum(NEE, na.rm = TRUE) * 1800 * 10^-6,
            # MAW = median(WTD, na.rm = TRUE),
            MAT = mean(TA_F, na.rm = TRUE),
            MAP = mean(P_F, na.rm = TRUE)) %>%
  filter(FCH4_an != 0) %>% 
  mutate(site = df$site[1])
  return(annual)
}

calc_annualWTD <- function(df) {
  annual <- df %>% 
  group_by(year = floor_date(as_date(date), 'year')) %>% 
  summarize(MAW = median(WTD, na.rm = TRUE)) %>%
  mutate(site = df$site[1])
  return(annual)
}

calc_monthly <- function(df) {
  monthly <- df %>%
  group_by(month = floor_date(as_date(date), 'month')) %>% 
  summarize(FCH4_mon = sum(FCH4_F, na.rm = TRUE) * 1800 * 10^-9,
            NEE_mon = sum(NEE_F, na.rm = TRUE) * 1800 * 10^-6,
            MMT = mean(TA_F, na.rm = TRUE),
            MMP = mean(P_F, na.rm = TRUE)) %>%
  # filter(FCH4_mon != 0) %>% 
  mutate(site = df$site[1]) %>% 
  return(monthly)
}

calc_monthlyWTD <- function(df) {
  monthly <- df %>%
  group_by(month = floor_date(as_date(date), 'month')) %>% 
  summarize(MMW = mean(WTD_F, na.rm = TRUE)) %>%
  # filter(FCH4_mon != 0) %>% 
  mutate(site = df$site[1]) %>% 
  return(monthly)
}

# test <- df_CNhgu %>% 
#   group_by(year = floor_date(as_date(date), 'year')) %>% 
#   summarize(MAP = mean(P, na.rm = TRUE))


append_annual <- function(df, annual) {
  df %>%
  group_by(year = floor_date(as_date(date), 'year')) %>% 
  summarize(FCH4_an = sum(FCH4_F, na.rm = TRUE) * 1800 * 10^-9,
            NEE_an = sum(NEE, na.rm = TRUE) * 1800 * 10^-6) %>% 
  filter(FCH4_an != 0) %>% 
  mutate(site = df$site[1]) %>% 
  full_join(annual)
}

append_monthly <- function(df, monthly) {
  df %>%
  group_by(month = floor_date(as_date(date), 'month')) %>% 
  summarize(FCH4_mon = sum(FCH4_F, na.rm = TRUE),
            TA_avg = mean(TA, na.rm = TRUE),
            P_mon = sum(P, na.rm = TRUE)) %>% 
  # filter(FCH4_mon != 0) %>% 
  mutate(site = df$site[1]) %>% 
  full_join(monthly)
}

sitelist_gra <- c('AT-Neu', 
                 'BW-Nxr',
                 'CH-Cha', 
                 'CN-Hgu', 
                 'NL-Hor', 
                 'SE-Deg', 
                 'US-NGC', 
                 'US-Snd', 
                 'US-Sne')
```
### import FLUXNET half-hourly files
```{r, echo=FALSE, return=FALSE}
fp <- 'data/FLUXNET-CH4/FLX_AT-Neu_FLUXNET-CH4_2010-2012_1-1/FLX_AT-Neu_FLUXNET-CH4_HH_2010-2012_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_ATneu <- read_site(fp) %>% 
  mutate(site = 'AT-Neu')

fp <- 'data/FLUXNET-CH4/FLX_BW-Nxr_FLUXNET-CH4_2018-2018_1-1/FLX_BW-Nxr_FLUXNET-CH4_HH_2018-2018_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_BWnxr <- read_site(fp) %>% 
  mutate(site = 'BW-Nxr')

fp <- 'data/FLUXNET-CH4/FLX_CH-Cha_FLUXNET-CH4_2012-2016_1-1/FLX_CH-Cha_FLUXNET-CH4_HH_2012-2016_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_CHcha <- read_site(fp) %>% 
  mutate(site = 'CH-Cha')

fp <- 'data/FLUXNET-CH4/FLX_CN-Hgu_FLUXNET-CH4_2015-2017_1-1/FLX_CN-Hgu_FLUXNET-CH4_HH_2015-2017_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_CNhgu <- read_site(fp) %>% 
  mutate(site = 'CN-Hgu')

fp <- 'data/FLUXNET-CH4/FLX_NL-Hor_FLUXNET-CH4_2007-2009_1-1/FLX_NL-Hor_FLUXNET-CH4_HH_2007-2009_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_NLhor <- read_site(fp) %>% 
  mutate(site = 'NL-Hor')

fp <- 'data/FLUXNET-CH4/FLX_SE-Deg_FLUXNET-CH4_2014-2018_1-1/FLX_SE-Deg_FLUXNET-CH4_HH_2014-2018_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_SEdeg <- read_site(fp) %>% 
  mutate(site = 'SE-Deg')

fp <- 'data/FLUXNET-CH4/FLX_US-NGC_FLUXNET-CH4_2017-2018_1-1/FLX_US-NGC_FLUXNET-CH4_HH_2017-2018_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_USngc <- read_site(fp) %>% 
  mutate(site = 'US-NGC')

fp <- 'data/FLUXNET-CH4/FLX_US-Snd_FLUXNET-CH4_2010-2015_1-1/FLX_US-Snd_FLUXNET-CH4_HH_2010-2015_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_USsnd <- read_site(fp) %>% 
  mutate(site = 'US-Snd')

fp <- 'data/FLUXNET-CH4/FLX_US-Sne_FLUXNET-CH4_2016-2018_1-1/FLX_US-Sne_FLUXNET-CH4_HH_2016-2018_1-1.csv'
fp <- file.path('/home', 'otto', fp)
df_USsne <- read_site(fp) %>% 
  mutate(site = 'US-Sne')
```
Ten grassland sites were identified in the FLUXNET-CH4 dataset, listed in Table 1 with site characterization metadata. 

- Ecosystem type? DOMVEG?
- CH4 flux data, micrometeorological data, and site characterization  

Gap-filled half-hourly NEE and CH4 fluxes were integrated over half-hours and summed to produce monthly and annual emissions. Missing data were ignored where present. Emissions were compared to annual and monthly means of total precipitation and air temperature. At three sites reporting water table depth (WTD) measurements, annual and monthly median gap-filled WTD served as a more representative measure of soil moisture.

- should missing half-hours be filled with previous value? mean/median value?
- does FCH4_F contain missing half-hours? 
- How many site-years are sinks vs sources of methane?
- What are the magnitude of those respective sinks and sources?
- What are their dependencies on temperature and precipitation?
- Fluxes vs DOMVEG at each site
- Don't need time series for annually summed fluxes - plot on temp/precip space 
- plot on temp-WTD, take median of water table depth if spikes are too extreme or noisy

```{r, echo=FALSE}
annual <- calc_annual(df_ATneu) %>% 
  full_join(calc_annual(df_BWnxr)) %>% 
  full_join(calc_annual(df_CHcha)) %>% 
  full_join(calc_annual(df_CNhgu)) %>% 
  full_join(calc_annual(df_NLhor)) %>% 
  full_join(calc_annual(df_SEdeg)) %>% 
  full_join(calc_annual(df_USngc)) %>% 
  full_join(calc_annual(df_USsnd)) %>% 
  full_join(calc_annual(df_USsne)) 

df_WTDan <- calc_annualWTD(df_USsne) %>% 
  full_join(calc_annualWTD(df_USsnd)) %>% 
  full_join(calc_annualWTD(df_SEdeg))

annualWTD <- annual %>% 
  left_join(df_WTDan, by=c('year', 'site'))

# annual <- annual %>% 
#   left_join(annualWTD, by = c('site', 'year', 'FCH4_an', 'NEE_an', 'MAT', 'MAP'), keep=FALSE)



monthly <- calc_monthly(df_ATneu) %>% 
  full_join(calc_monthly(df_BWnxr)) %>% 
  full_join(calc_monthly(df_CHcha)) %>% 
  full_join(calc_monthly(df_CNhgu)) %>% 
  full_join(calc_monthly(df_NLhor)) %>% 
  full_join(calc_monthly(df_SEdeg)) %>% 
  full_join(calc_monthly(df_USngc)) %>% 
  full_join(calc_monthly(df_USsnd)) %>% 
  full_join(calc_monthly(df_USsne)) 
  

df_WTDmon <- calc_monthlyWTD(df_USsne) %>% 
  full_join(calc_monthlyWTD(df_USsnd)) %>% 
  full_join(calc_monthlyWTD(df_SEdeg))

monthlyWTD <- monthly %>% 
  left_join(df_WTDmon, by=c('month', 'site'))

# monthly <- monthly %>% 
#   full_join(monthlyWTD, by = c('site', 'month'))



```

added MAW and MMW to annual and monthly, but need to select only sites with WTD: US-Sne, US-Snd, SE-Deg

```{r}
# compute radiative balance
# NEE (umol m-2) * 1 + FCH4 (nmol m-2) * 34 = rad (umol m-2 C equivalent)
annual <- annual %>% 
  mutate(rad = NEE_an + FCH4_an * 34 * 10^-3)

annualWTD <- annualWTD %>% 
  mutate(rad = NEE_an + FCH4_an * 34 * 10^-3)

monthly <- monthly %>% 
  mutate(rad = NEE_mon + FCH4_mon * 34 * 10^-3)

monthlyWTD <- monthlyWTD %>% 
  mutate(rad = NEE_mon + FCH4_mon * 34 * 10^-3)

# plot annual ch4 fluxes
ggplot(annual, aes(x = year)) + 
  geom_point(aes(y=FCH4_an, color=site)) +
  theme_minimal()

# plot annual NEE
ggplot(annual, aes(x = year)) + 
  geom_point(aes(y=NEE_an, color=site)) +
  theme_minimal()

# plot annual ch4 flux on MAT vs MAP
ggplot(annual, aes(x=MAT, y=MAP)) +
  geom_point(aes(size = FCH4_an, color = site)) +
  theme_minimal()

# plot annual NEE on MAT vs MAP
ggplot(annual, aes(x=MAT, y=MAP)) +
  geom_point(aes(size = NEE_an, color = site)) +
  theme_minimal()

# plot monthly ch4 flux on MMT vs MMP
ggplot(monthly, aes(x=MMT, y=MMP)) +
  geom_point(aes(size = FCH4_mon, color = site)) +
  theme_minimal()

# plot monthly NEE on MMT vs MMP
ggplot(monthly, aes(x=MMT, y=MMP)) +
  geom_point(aes(size = NEE_mon, color = site)) +
  theme_minimal()

# plot annual ch4 flux on MMT vs MMW
ggplot(annualWTD, aes(x=MAT, y=MAW)) +
  geom_point(aes(size = FCH4_an, color = site)) +
  theme_minimal()

# plot monthly ch4 flux on MMT vs MMW
ggplot(monthlyWTD, aes(x=MMT, y=MMW)) +
  geom_point(aes(size = FCH4_mon, color = site)) +
  theme_minimal()

ggplot(df_USsne, aes(x=date, y=WTD_F)) +
  geom_point()

ggplot(monthlyWTD, aes(x=month, y=MMW)) +
  geom_point()
```

```{r}
# plot radiative balance (NEE*1 + FCH4*34)
ggplot(annual, aes(x = year)) + 
  geom_point(aes(y=rad, color=site)) +
  theme_minimal()

ggplot(monthlyWTD, aes(x=MMT, y=MMW)) +
  geom_point(aes(color = rad)) +  
  scale_color_gradient2(low = 'yellow', high = 'green')
  theme_minimal()

```

Most sites exhibit a negative radiative balance owing to high primary productivity. US-Sne had a strong positive radiative balance in 2017 and 2018 due to high FCH4  and moderate NEE, while a more negative NEE and less extreme FCH4 gave the site a slightly negative radiative balance in 2016
```r
# aggregate monthly fluxes
monthly <- df_ATneu %>%
  group_by(month = floor_date(as_date(date), 'month')) %>% 
  summarize(FCH4_mon = sum(FCH4_F, na.rm = TRUE),
            TA_avg = mean(TA, na.rm = TRUE),
            P_mon = sum(P, na.rm = TRUE)) %>% 
  # filter(FCH4_mon != 0) %>% 
  mutate(site = df_ATneu$site[1])

monthly <- append_monthly(df_BWnxr, monthly)
monthly <- append_monthly(df_CHcha, monthly)
monthly <- append_monthly(df_CNhgu, monthly)
monthly <- append_monthly(df_NLhor, monthly)
monthly <- append_monthly(df_SEdeg, monthly)
monthly <- append_monthly(df_USngc, monthly)
monthly <- append_monthly(df_USsnd, monthly)
monthly <- append_monthly(df_USsne, monthly)

# FCH4, P, and TA vs time
pFCH4 <- ggplot(monthly, aes(x = month)) + 
  geom_point(aes(y=FCH4_mon, color=site)) +
  theme_minimal()

pTA <- ggplot(monthly, aes(x = month)) + 
  geom_point(aes(y=TA_avg, color=site)) +
  theme_minimal()

pP <- ggplot(monthly, aes(x = month)) + 
  geom_point(aes(y=P_mon, color=site)) +
  theme_minimal()

pFCH4 / pTA / pP

# FCH4 on TA and P axes

ggplot(monthly, aes(x=TA_avg, y=P_mon)) +
  geom_point(aes(size = FCH4_mon, color = site))

# SE-deg FCH4_F vs WTD

p1 <- ggplot(df_SEdeg, aes(date, FCH4_F)) + 
  geom_point()

p2 <- ggplot(df_SEdeg, aes(date, y=WTD)) +
  geom_line()

p1 / p2

# US-Snd FCH4_F vs WTD

p1 <- ggplot(df_USsnd, aes(date, FCH4_F)) + 
  geom_point()

p2 <- ggplot(df_USsnd, aes(date, y=WTD)) +
  geom_line()

p1 / p2

# US-Sne FCH4_F vs WTD

p1 <- ggplot(df_USsne, aes(date, FCH4_F)) + 
  geom_point()

p2 <- ggplot(df_USsne, aes(date, y=WTD)) +
  geom_line()

p1 / p2
```